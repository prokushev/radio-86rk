; 
;  -2.00  -86  580, ᮢ⨬  ਮ-128,
;  প VT-52  ஬ CP/M
; 
;  , 室   2 ROM-᪠
; 

	CPU		8080
	Z80SYNTAX	EXCLUSIVE

; 
;
;  ࠧ    128 . ᥣ 16 .   ࠭᫨-
; ஢  믮   ROMBUF. 맮    ⢫
;   
;
; FCALL block, label
; 
;  block -  , 稭  0,  label - ⪠ ;
; 

; 
;  ⥬ 맮
; 

	INCLUDE	"syscalls.inc"
	IF	STUB
	INCLUDE	"stub.inc"
	ELSE
	INCLUDE	"MON580-2.INC"
	ENDIF

; 
;  ⥬ ६
; 

	INCLUDE	"sysvars.inc"


FCALL	MACRO	block, adr
		CALL	CALLROM
		DB	block
		DB	LOW adr
	ENDM

FJPZ	MACRO	block, adr
		RST	8
		DB	block
		DB	adr & 0FFH
	ENDM


CHK	MACRO	adr, msg
		IF	$>(adr)
			ERROR	msg
		ENDIF
	ENDM

; 
;  0. 樠
; 

	ORG	0
	PHASE	ROMBUF

; 
;   㧪  ਮ-128. 뢮
; ᮮ饭,    ।祭  -86.
; 
ORDOSStart:
	LD	HL, MsgRKOnly
	CALL	PrintString
	JP	WarmBoot
MsgRKOnly:
	DB	"|tot ROM-disk prednazna~en dlq radio-86r",'k' + 80H

; 
; 樠 ᨬ CP/M
; 頥 窨 室  BIOS  BDOS
; 

	SHARED	INITBDOS
INITBDOS:
	LD	A, 0C3H				; JMP opcode
	
	; CALL 0
	LD	(0), A
	LD	HL, BIOSENTRY+3	; WBOOT
	LD	(0001H), HL

	; CALL 5
	LD	(5), A
	LD	HL, BDOSST
	LD	(0006H), HL

	; BDOS Entry point
	LD	(BDOSST), A
	LD	HL, BDOS
	LD	(BDOSST+1), HL

	; RST 8 (Far Jump if zero)
	LD	(8), A
	LD	HL, FARJZ
	LD	(9), HL

	LD	HL, CPMMSG
	CALL	PrintString
	JP	WarmBoot
CPMMSG:
	DB	' s |mulqtorom CP/','M'+80H

	CHK	ROMBUF+ROMBUFMAX, "* Block overflow ! *"
	DEPHASE

; 
;  1 室  BDOS
; 

	ORG	080H
	PHASE	ROMBUF

; 
;  樨 祪 室 BDOS
; 
; To make a BDOS call in an 8-bit CP/M, use:
;
;    LD  DE,parameter
;    LD  C,function
;    CALL    5
;
; In CP/M 1.x, 8-bit values are returned in A and 
; 16-bit values in BA. In later 8-bit versions,
; they are also returned in L and HL respectively. 
; 

	SHARED	BDOSENTRY
BDOSENTRY:
	LD	HL, 0000H		; ࠭塞 ⥪
	ADD	HL, SP
	LD	(TMPSTK), HL
	LD	SP, STACK
	DEC	C
	JP	M, WarmBoot		; 㭪 0 P_TERMCPM
	LD	HL, BDOSRET
	PUSH	HL
	LD	A, C
	LD	C, E
	FJPZ	2, C_READ		; 㭪 1 C_READ
	DEC	A
	JP	Z, PrintCharFromC	; 㭪 2 C_WRITE
	SUB	4
	FJPZ	2, C_RAWIO		; 㭪 6 C_RAWIO
	SUB	3
	FJPZ	2, C_WRITESTR		; 㭪 9 C_WRITESTR
	DEC	A
	FJPZ	2, C_READSTR		; 㭪 10 C_READSTR
	DEC	A
	JP	Z, GetKeyboardStatus	; 㭪 11 C_STAT
	DEC	A
	JP	NZ, WarmBoot	; 㭪樨 13    ন
	LD	A, 20H		; 㭪 12 S_BDOSVER
	LD	B, 00H
	RET

	CHK	ROMBUF+ROMBUFMAX, "* Block overflow ! *"
	DEPHASE

; 
;  2 㭪樨 BDOS
; 

	ORG	0100H
	PHASE	ROMBUF

; 
;  ப   DE
; :
;	DE	-  ப. $ - ਧ 
;		   ᨬ  7Fh
; :
;	HL	-  ᫥ ⠭ ᨬ
; :
;	AF, B, HL, DE
; 

C_WRITESTR:
	LD	HL, PrintString+1
	INC	HL
	INC	HL
	PUSH	HL
	EX	DE, HL
	LD	B, '$'
	RET			; JP PrintString+2, .. ய⨫ LD B, 0

C_READ:	EX	(SP),HL		; ⠭ HL  ⥪
	CALL	InputSymbol	; 6 bytes
	JP	PrintCharFromA

; 
;BDOS function 6 (C_RAWIO) - Direct console I/O
;Supported by: CP/M 1.4 and later, with variations
;Entered with C=6, E=code. Returned values (in A) vary.
;
;E=0FFh
;Return a character without echoing if one is waiting;
; zero if none is available. In MP/M 1, this works like
; E=0FDh below and waits for a character.
;Values of E not supported on a particular system will
; output the character. Under CP/M 2 and lower, direct 
;console functions may interact undesirably with non-direct
; ones, since certain buffers may be bypassed. Do not mix them.
; 

C_RAWIO:
	INC	E		; Test for 0FFH
	JP	NZ,PrintCharFromC
	CALL	GetKeyboardStatus
	RET	Z
	JP	InputSymbol

; 
;  ப   DE (CP/M ᮢ⨬)
; :
;	DE	-  
; :
;	COMBUF	-  ப
; :
;	AF, DE, HL, BC
; 

C_READSTR:
	PUSH	DE
	POP	HL
	LD	C, (HL)
	INC	HL
GotoCmdLineBegin:
	XOR	A
	LD	B, A
InputNextSymbol:
	CALL	InputSymbol		; ᯮ  DirectiveModify
	CP	7FH
	JP	Z,ProcessBackspace
	INC	HL
	LD	(HL), A
	CALL	PrintCharFromA
	CP	13
	JP	Z,L00B2H
	CP	03
	JP	Z,WarmBoot
	INC	B
	LD	A, C
	CP	B
	JP	NZ, InputNextSymbol;	SyntaxError
	LD	B, C
L00B2H:	INC	DE
	EX	DE, HL
	LD	(HL), B
	RET

ProcessBackspace:
	LD	A,B			; 15 bytes
	OR	A			; 砫   ?
	JP	Z,GotoCmdLineBegin	; GotoCmdLineBegin
	DEC	B
	DEC	HL
	PUSH	HL
	LD	HL, BkSp
	CALL	PrintString
	pop	HL
	JP	InputNextSymbol

BkSp:	DB	8,' ',8+80H

	CHK	ROMBUF+ROMBUFMAX, "* Block overflow ! *"
	DEPHASE

; 
;  3 譨 ४⨢ 
; 

	ORG	0180H
	PHASE	ROMBUF

	SHARED	DirectiveModifyROM
DirectiveModifyROM:
	CALL	PrintCRAndHexWordAndSpaceAndHexByteMemAndSpace			; 22 bytes
	PUSH	HL
	CALL	InputDirective
	POP	HL
	JP	NC,AFA3B
	PUSH	HL
	CALL	GET_HL
	LD	A,L
	POP	HL
	LD	(HL),A
AFA3B:	INC	HL
	JP	DirectiveModifyROM

; 
;     HL  DE
; :
;	HL	- 砫 
;	DE	-  
; :
;	HL	-   筨
; :
;	AF, HL		!!TODO!! ஢ ணࠬ  
; 

	SHARED	DirectiveDumpROM
DirectiveDumpROM:
	CALL	PrintCRAndHexWordAndSpace			; 18 bytes
AF9C8:	CALL	PrintHexByteFromMemAndSpace
	CALL	IncHLAndRetIfEqDEWithBrk
	LD	A,L
	AND	0FH
	JP	Z,DirectiveDumpROM
	JP	AF9C8

; 
; 뢮 ⥪    HL  DE
; :
;	HL	- 砫 
;	DE	-  
; :
;	HL	-   筨
; :
;	AF, HL		!!TODO!! ஢ ணࠬ  
; 

	SHARED	DirectiveListROM
DirectiveListROM:
	CALL	PrintCRAndHexWordAndSpace			; 30 bytes
AFA0B:	LD	A,(HL)
	OR	A
	JP	M,AFA15
	CP	20H
	JP	NC,AFA17
AFA15:	LD	A,'.'
AFA17:	CALL	PrintCharFromA
	CALL	IncHLAndRetIfEqDEWithBrk
	LD	A,L
	AND	0FH
	JP	Z,DirectiveListROM
	JP	AFA0B

; 
; ६頥    HL  DE   BC
; :
;	HL	- 砫 
;	DE	-  
;	BC	- 楫 
; :
;	HL	-   筨
;	BC	- 楫  
; :
;	AF, HL, BC
; 

	SHARED	DirectiveTransferROM
DirectiveTransferROM:
	LD	A,(HL)			; 9 bytes
	LD	(BC),A
	INC	BC
	CALL	IncHLAndRetIfEqDE
	JP	DirectiveTransferROM

; 
;   C     HL  DE
; :
;	HL	- 砫 
;	DE	-  
;	C	- ᪮ 
; :
;	HL	-   筨
; :
;	AF, HL
; 

	SHARED	DirectiveSearchROM
DirectiveSearchROM:
	LD	A,C			; 11 bytes
	CP	(HL)
	CALL	Z,PrintCRAndHexWordAndSpace
	CALL	IncHLAndRetIfEqDEWithBrk
	JP	DirectiveSearchROM

	SHARED	DirectiveCompareROM
DirectiveCompareROM:
	LD	A,(BC)			; 19 bytes
	CP	(HL)
	JP	Z,AF9E6
	CALL	PrintCRAndHexWordAndSpaceAndHexByteMemAndSpace
	LD	A,(BC)
	CALL	PrintHexByteAndSpace
AF9E6:	INC	BC
	CALL	IncHLAndRetIfEqDEWithBrk
	JP	DirectiveCompareROM

	CHK	ROMBUF+ROMBUFMAX, "* Block overflow ! *"
	DEPHASE

; 
;  4
; 

	ORG	0200H
	PHASE	ROMBUF

	DB	80H dup 0ffH

	CHK	ROMBUF+ROMBUFMAX, "* Block overflow ! *"
	DEPHASE

; 
;  5
; 

	ORG	0280H
	PHASE	ROMBUF

	DB	80H dup 0ffH

	CHK	ROMBUF+ROMBUFMAX, "* Block overflow ! *"
	DEPHASE

; 
;  6
; 

	ORG	0300H
	PHASE	ROMBUF

	DB	80H dup 0ffH

	CHK	ROMBUF+ROMBUFMAX, "* Block overflow ! *"
	DEPHASE

; 
;  7
; 

	ORG	0380H
	PHASE	ROMBUF

	DB	80H dup 0ffH

	CHK	ROMBUF+ROMBUFMAX, "* Block overflow ! *"
	DEPHASE

; 
;  8
; 

	ORG	0400H
	PHASE	ROMBUF

	DB	80H dup 0ffH

	CHK	ROMBUF+ROMBUFMAX, "* Block overflow ! *"
	DEPHASE

; 
;  9
; 

	ORG	0480H
	PHASE	ROMBUF

	DB	80H dup 0ffH

	CHK	ROMBUF+ROMBUFMAX, "* Block overflow ! *"
	DEPHASE

; 
;  10
; 

	ORG	0500H
	PHASE	ROMBUF

	DB	80H dup 0ffH

	CHK	ROMBUF+ROMBUFMAX, "* Block overflow ! *"
	DEPHASE

; 
;  11
; 

	ORG	0580H
	PHASE	ROMBUF

	DB	80H dup 0ffH

	CHK	ROMBUF+ROMBUFMAX, "* Block overflow ! *"
	DEPHASE

; 
;  12
; 

	ORG	0600H
	PHASE	ROMBUF

	DB	80H dup 0ffH

	CHK	ROMBUF+ROMBUFMAX, "* Block overflow ! *"
	DEPHASE

; 
;  13
; 

	ORG	0680H
	PHASE	ROMBUF

	DB	80H dup 0ffH

	CHK	ROMBUF+ROMBUFMAX, "* Block overflow ! *"
	DEPHASE

; 
;  14
; 

	ORG	0700H
	PHASE	ROMBUF

	DB	80H dup 0ffH

	CHK	ROMBUF+ROMBUFMAX, "* Block overflow ! *"
	DEPHASE

; 
;  15
; 

	ORG	0780H
	PHASE	ROMBUF

	DB	80H dup 0ffH

	CHK	ROMBUF+ROMBUFMAX, "* Block overflow ! *"
	DEPHASE

; 
; ᨪ
; 

	ORG 0800H
BASICROM:
	BINCLUDE "basic.rom"
EDASMROM:
	BINCLUDE "edasm.rom"
DPDDTROM:
	BINCLUDE "dpddt.rom"
SORTUTROM:
	BINCLUDE "sortut.rom"

; 
;   ROM-DISK/32K   
;"-86"  OEMOM   32.
;     
;  7E00H-7FFFH.    
;   ROM-DISK. 
;      , 
;( MONITORE)   "U"   
;   ,   7400.
; 

	ORG	07E00H
	
	PHASE	07400H

CONST:	EQU	6     	;  
M0:	LD	HL,SO1 	;   
M1:	CALL	PrintString 	;ROM-DISK/32K 
	CALL    InputSymbol    	;  . 
	CP	'Z'   	;   0?
 	JP	Z, ZERO	;,
	CP     'S'   	;    
	JP	Z, SAVE  	; ?- ,
 	CP     'L'   	;   
	JP	Z, LOAD	; ?-, 
 	CP     'M'   	;
	JP	Z, WarmBoot	;
	SUB     30H   	;    
	JP	M, M0  	;    
	CP     CONST 	;   ? 
	JP	NC, M0 	;,  . 
	LD	B,A   	;,  . 
	OR	A     	; 0?   
	JP	NZ, M2 	;,   . 
	XOR     A     	;,   
	LD	(2117H),A 	;  BASIC. 
M2:	LD      DE,6   	;   . 
	LD      HL,TABL	;   . 
	XOR     A     	;   
M3:	CP     B     	;   ? 
	JP	Z, M4    	;,   . 
	ADD     HL, DE     	;,    
	INC     A     	;  ,  
	JP     M3    	;    
M4:	LD	SP, HL  ; ,
	POP     HL     	;  
	POP     DE     	;  
	POP     BC     	; . 
	DEC     SP    	;   
	DEC     SP    	; - .

;  MONITORA,   
;        
;   . 
	CALL    ReadROM	;0FA68H	;  . 
	POP     HL     	;   
	JP	(HL)          	;  .

;       
;    "". 
LOAD:	LD     HL, SO4 	;  
	CALL    PrintString 	; . 
	LD     HL,4A00H	;  
	LD     DE,2100H	;BPEMEHHOO . 
RD0:	LD     BC,28FFH	;OEM . 
RD1:	LD     A,(HL)   	;
	LD	(DE),A     	; 
	INC     HL     	;3
	INC     DE     	;  
	DEC     BC     	;B   
	LD     A,B   	;  2100. 
	OR     C     	; 
	JP	NZ,     RD1   	; 
	JP     M0    	;  .

;     
; .     28FFH,  
;     . 
SAVE:	LD     HL, 2100H
S1:	LD     A,(HL)   	; 
	CP     0FFH  	; . 
	JP	Z, S2    	;  HE  
	INC     HL     	;  
	LD     A, H   	; ,  
	CP     4AH   	; 
	JP	NZ,     S1    	;
	LD     HL,SO6 	;,   
	JP     M1    	;HE .
S2:	LD 	HL,SO5 	; 
	CALL 	PrintString 	; 
	LD 	HL,2100H	;  .
	LD 	DE,4A00H ;
	JP 	RD0 	;  .

;   ( "0")
;BO     ,
;  ,   7400).
ZERO:	LD 	HL,SO5 	; 
	CALL 	PrintString 	;   RAM.
	LD 	HL,0 	;
Z1:	LD 	(HL),0 	;
	INC 	HL 	; .
	LD 	A,H 	;
	CP 	74H 	;  
	JP	NZ, 	Z1 	; 7400,  
	JP 	M0 	; .

SO1:	DB 	1FH
	DB	0CH,"*ROM-DISK/32K* V2.1-23";
	DB 	0AH,0AH,0DH,"DIR:";
	DB 	0DH,0AH,"<0>-BASIC";
	DB 	0DH,0AH,"<1>-ED/ASSM";
	DB 	0DH,0AH,"<2>-DP/DDT";
	DB 	0DH,0AH,"<3>-SORT UT";
	DB 	0DH,0AH,"<4>-DRIV/260";
	DB 	0DH,0AH,"<5>-PROGR" ;
	DB 	0AH,0DH
	DB 	0AH,0DH," <S>-SAVE TO BUFFER";
	DB 	0AH,0DH," <L>-READ FROM BUFFER" ;
	DB 	0AH,0DH," <Z>-FILL RAM WITH ZERO" ;
	DB 	0AH,0DH," <M>-MONITOR" ;
	DB 	0DH,0AH,0
SO3:	DB 	19H		;
SO4:	DB 	19H		;
SO5:	DB 	19H,19H,7FH,08H,0
SO6:	DB 	0DH,"OUT OF BUFFER",0

;   ROM-DISK/32K.
;   ;
;,     .
;      .
TABL:	DW	BASICROM, BASICROM+1FFFH,0 	; BASIC
	DW 	EDASMROM, EDASMROM+0FFFH,0	; RED/ASSM
	DW 	DPDDTROM, DPDDTROM+0FFFH,6400H	; DP/DDT
	; TODO  ࠧ -  祭 ⭮.   㡫樥.
	DW 	SORTUTROM+800H, SORTUTROM+0E95H,000H	; SORT/UT
	DW 	74E4H,7A94H,800H		; DRIV/260
	DW 	7A95H,7DFFH,0			; PROGR

	ORG	07FFFH
	NOP
	DEPHASE
	CHK	08000H, "* Block overflow ! *"
	END 				;

